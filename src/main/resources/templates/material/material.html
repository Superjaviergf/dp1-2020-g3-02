<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />

<link rel="stylesheet"
	href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
	integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
	crossorigin="anonymous" />

<!-- Bootstrap CSS -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
	integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
	crossorigin="anonymous">

<!--  Datatables  -->
<link rel="stylesheet" type="text/css"
	href="https://cdn.datatables.net/v/bs4/dt-1.10.20/datatables.min.css" />

<!--  extension responsive  -->

<link rel="stylesheet" type="text/css"
	href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">
<title>Listado materiales</title>
<link rel="icon" type="image/png"
	href="https://images.vexels.com/media/users/3/181410/isolated/preview/eb4635102ef855d3f98d7805ec155a77-icono-de-deportes-de-pelota-de-voleibol-by-vexels.png" />
</head>

<style>
.alert {
	position: absolute;
	top: 5%;
	right: 38%;
	padding: 20px;
	background-color: #f44336;
	color: white;
	opacity: 1;
	z-index: 20000;
	transition: opacity 0.6s;
	margin-bottom: 15px;
}

.alert.success {
	background-color: #4CAF50;
}

.closebtn {
	margin-left: 15px;
	color: white;
	font-weight: bold;
	float: right;
	font-size: 22px;
	line-height: 20px;
	cursor: pointer;
	transition: 0.3s;
}

.closebtn:hover {
	color: black;
}
</style>

<body class="bg-light">

	<script src="https://www.w3schools.com/lib/w3data.js"></script>

	<div class="">
		<div w3-include-html="navbar?id=materiales"></div>
	</div>

	<div class="container-fluid">
		<div class="row">
			<div class="py-3 text-center col-lg-12">
				<h1 class="font-weight-bold font-italic">LISTA MATERIALES</h1>
			</div>
		</div>

		<div class="alert success invisible exito">
			<span class="closebtn ">&times;</span> <strong>Success!</strong> No
			confiaban en mi pero aquí está, añadido con éxito
		</div>

		<div class="row">
			<div class="col-lg-12 responsive">
				<table id="materiales"
					class="table table-sm table-striped table-bordered table-hover nowrap"
					cellspacing="0" style="width: 100%;">
					<thead>
						<tr class="table-primary">
							<th>Material</th>
							<th>Stock</th>
							<th>Estado materiales</th>
							<th>Porcentaje de uso</th>
							<th>Añadir Materiales</th>


						</tr>
					</thead>
					<tbody>

						<tr th:each="material : ${materiales}">
							<td th:text="${material.tipo}"></td>
							<td th:text="${material.stock}"></td>
							<td th:text="${material.estado}"></td>
							<td th:text="${material.stock*100}+'%'"></td>
							
							<td><input type="hidden" id="id" th:value="${material.id}"></input>


								<button sec:authorize="hasAuthority('entrenador')"
									class="btn btn-outline-info mx-0 editar" type="button"
									title="Editar">Añadir</button> <input id="security"
								type="hidden" sec:authorize="hasAuthority('entrenador')"
								th:value="entrenador"></td>
					</tbody>

				</table>
			</div>
		</div>
	</div>
	<!-- Modal Edicion -->
	<div class="modal fade" id="editarModal" data-backdrop="static"
		data-keyboard="false" tabindex="-1" aria-labelledby="Editar"
		aria-hidden="true">
		<div class="modal-dialog modal-xl modal-dialog-centered">
			<div class="modal-content">
				<form id="formEditMaterial" method="post">
					<div class="modal-header bg-info">
						<h5 class="modal-title" id="edicionMaterial"></h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="contenedor-modal">

							<div class="row">
								<div class="form-group col">
									<label><span class="text-danger">(*) </span>Stock:</label><input
										class="form-control" type="number" placeholder="Stock"
										th:id="stock" name="stock" required></input> <small
										class="stock text-danger error"></small>
								</div>


							</div>
						</div>
					</div>
					<div class="modal-footer"
						style="background: rgb(23, 162, 184); background: linear-gradient(0deg, rgba(23, 162, 184, 0.75) 0%, rgba(255, 255, 255, 1) 100%);">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">Cerrar</button>
						<button type="button" class="btn btn-info"
							onclick="return enviarEdicion();">Aceptar</button>
						<input type="hidden" th:id="id" name="id"></input>
					</div>
				</form>
			</div>
		</div>
	</div>



	<th:block layout:fragment="scripts">
		<script src=https://code.jquery.com/jquery-3.5.1.js></script>
		<!-- Optional JavaScript -->
		<script
			src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
			integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
			crossorigin="anonymous"></script>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
			integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
			crossorigin="anonymous"></script>


		<script>
			var tipo = $('#security').val();
			if (tipo == 'jugador') {
				document.getElementById("materiales").classList
						.remove('table-sm');
			} else if (tipo == 'entrenador') {
				document.getElementById("materiales").classList
						.remove('table-sm');
				document.getElementById("materiales").classList.add('table-sm');
			}

			function enviarEdicion() {
				var form = new FormData(document
						.getElementById('formEditMaterial'));
				$.ajax({
					url : '/materiales/updatematerial',
					type : 'post',
					data : form,
					processData : false,
					contentType : false,
					success : function(data) {
						$('#editarModal').modal("hide");
						location.reload();
					},
					error : function(data) {

						$('.error').text('');

						for (i = 0; i < data.responseJSON.length; i++) {

							var campo = data.responseJSON[i].field;
							$('.' + campo).text(
									data.responseJSON[i].defaultMessage);
						}
					}
				});
			};
			$(document)
					.ready(
							function() {
								var tablaPrincipal = $('#materiales')
										.DataTable(
												{
													responsive : true,
													columnDefs : [ {
														responsivePriority : 0,
														targets : 0
													}, {
														responsivePriority : 0,
														targets : -1
													}, {
														responsivePriority : 2,
														targets : 6
													}, {
														responsivePriority : 2,
														targets : 7
													}, {
														responsivePriority : 1,
														targets : 9
													} ],
													"language" : {
														"url" : "https:////cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
													}
												});

								tablaPrincipal.column(-2).visible(false);

								$('table .editar')
										.on(
												'click',
												function() {
													var id = $(this).parent()
															.find('#id').val();
													$('.error').text('');
													$
															.ajax({
																type : 'GET',
																url : '/materiales/findeditmaterial/'
																		+ id,
																success : function(
																		edit) {

																	$(
																			'#editarModal #stock')
																			.val(
																					edit.stock);

																	$(
																			'.modal-header')
																			.css(
																					"color",
																					"white");
																	$(
																			'.modal-title')
																			.text(
																					"Editar a "
																							+ edit.tipo);
																	$(
																			'#editarModal')
																			.modal(
																					"show");
																}
															});
												});
							});
		</script>
		<script type="text/javascript">
			w3IncludeHTML();
		</script>
	</th:block>
</body>
</html>
